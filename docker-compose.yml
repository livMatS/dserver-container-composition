version: '2'

volumes:
  mongodb_data: {}
  postgres_data: {}
  cert_data: {}

services:
  mongodb:
    image: mongo:latest
    restart: always
    volumes:
      - mongodb_data:/data/db

  postgres:
    image: postgres:latest
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data

  dtool_lookup_server:
    image: jotelha/dtool-lookup-server:latest
    restart: always
    depends_on:
      mongodb:
        condition: service_started
      postgres:
        condition: service_started
      token_generator_ldap:
        condition: service_started
      omgwtfssl:
        condition: service_started
    command: /start
    volumes:
      - type: volume
        source: cert_data
        target: /certs
        read_only: True
      - type: bind
        source: ./keys/dtool_lookup_server
        target: /run/secrets
        read_only: True

  token_generator_ldap:
    image: jotelha/dtool-token-generator-ldap:latest
    restart: always
    command: /start
    volumes:
      - type: volume
        source: cert_data
        target: /certs
        read_only: True
      - type: bind
        source: ./keys/token_generator_ldap
        target: /run/secrets
        read_only: True

  omgwtfssl:
    image: paulczar/omgwtfssl:latest
    restart: "no"
    volumes:
      - cert_data:/certs
