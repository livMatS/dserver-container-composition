version: '2'

volumes:
  mongodb_data: {}
  postgres_data: {}

services:
  mongodb:
    image: mongo:${MONGO_CONTAINER_IMAGE_VERSION}
    restart: always
    volumes:
      - mongodb_data:/data/db

  postgres:
    image: postgres:${POSTGRES_CONTAINER_IMAGE_VERSION}
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data

  dtool_lookup_server:
    image: jotelha/dtool-lookup-server:${DTOOL_LOOKUP_SERVER_CONTAINER_IMAGE_VERSION}
    restart: always
    depends_on:
      mongodb:
        condition: service_started
      postgres:
        condition: service_started
      token_generator_ldap:
        condition: service_started
    command: /start
    volumes:
      - type: bind
        source: ./keys/dtool_lookup_server
        target: /run/secrets
        read_only: True

  token_generator_ldap:
    image: jotelha/dtool-token-generator-ldap:${DTOOL_TOKEN_GENERATOR_LDAP_CONTAINER_IMAGE_VERSION}
    restart: always
    command: /start
    volumes:
      - type: bind
        source: ./keys/token_generator_ldap
        target: /run/secrets
        read_only: True